<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pyodide Shell met Setup</title>
  <style>
    #editor { height: 200px; width: 100%; }
    #shell { font-family: monospace; margin-top: 1em; }
    #shell-output { background: #eee; padding: 1em; height: 200px; overflow-y: auto; white-space: pre-wrap; }
    #shell-input { width: 100%; font-family: monospace; padding: 0.5em; }
    button { margin-top: 0.5em; }
  </style>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
</head>
<body>
  <h2>Setupcode (functies en constanten)</h2>
  <div id="editor">def greet(name):\n    print(f"Hallo, {name}!")</div>
  <button onclick="runSetup()">Run setup</button>

  <div id="shell">
    <h2>Shell</h2>
    <div id="shell-output"></div>
    <input id="shell-input" placeholder=">>> Typ een expressie of statement" autocomplete="off" />
  </div>

  <script>
let example = 
`import math

def isPrime(n):
    wn = math.sqrt(n)
    wn = math.trunc(wn)
    for k in range(2,wn+1):
        if n % k == 0:
            return False
    return True

def goldbach_bounded(b):
    # every even number is the sum of 2 primes
    # program
    n = 4
    while n < b:
        if not isSum2Primes(n):
            return False
        n += 2
    return True

def goldbach():
    # every even number is the sum of 2 primes
    # program
    n = 4
    while True:
        if not isSum2Primes(n):
            return False
        n += 2
    return True

def isSum2Primes(n):
    for k in range(2,n//2+1):
        if isPrime(k) and isPrime(n-k):
            return True
    return False
print(goldbach_bounded(10000))
`

let pyodide;

    async function init() {
      editor.setValue = example;
      pyodide = await loadPyodide();
      await redirectOutput();
    }

    async function redirectOutput() {
      class Stdout {
        constructor() {
          this.buffer = "";
        }
        write(s) {
          this.buffer += s;
          if (s.includes("\n")) {
            appendToShell(this.buffer.trimEnd());
            this.buffer = "";
          }
        }
        flush() {}
      }
      pyodide.globals.set("stdout", new Stdout());
      pyodide.globals.set("stderr", new Stdout());
      await pyodide.runPythonAsync(`
        import sys
        sys.stdout = stdout
        sys.stderr = stderr
      `);
    }

    function appendToShell(text) {
      const div = document.getElementById("shell-output");
      div.textContent += text + "\n";
      div.scrollTop = div.scrollHeight;
    }

    function filterErrorMessage(rawError) {
      const lines = rawError.toString().split("\n");
      return lines.filter(line =>
        !(line.trim().startsWith('File "<') || line.trim() === "")
      ).join("\n");
    }

    async function runSetup() {
      const code = editor.getValue();
      try {
        await pyodide.runPythonAsync(code);
        appendToShell("[Setupcode uitgevoerd]");
      } catch (err) {
        appendToShell("Setup fout:\n" + filterErrorMessage(err));
      }
    }

    document.getElementById("shell-input").addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const input = e.target.value.trim();
        if (input === "") return;

        appendToShell(">>> " + input);
        e.target.value = "";

        try {
          try {
            await pyodide.runPythonAsync(`__shell_result = (${input})`);
            await pyodide.runPythonAsync("print(__shell_result)");
            await pyodide.runPythonAsync("del __shell_result");
          } catch (evalErr) {
            await pyodide.runPythonAsync(input);
          }
        } catch (err) {
          appendToShell("Fout:\n" + filterErrorMessage(err));
        }
      }
    });

    // Init bij laden
    editor;
    window.onload = () => {
      editor = ace.edit("editor", {
        mode: "ace/mode/python",
        theme: "ace/theme/github"
      });
      init();
    };
  </script>
</body>
</html>