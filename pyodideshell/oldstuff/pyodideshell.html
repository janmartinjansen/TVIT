<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pyodide met Ace Editor - Correcte foutregels</title>
  <style>
    #editor {
      width: 100%;
      height: 200px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    #shell { font-family: monospace; margin-top: 1em; }
    #shell-output { background: #eee; padding: 1em; height: 200px; overflow-y: auto; white-space: pre-wrap; }
    #shell-input { width: 100%; font-family: monospace; padding: 0.5em; }

    #output {
      white-space: pre-wrap;
      background: #f0f0f0;
      padding: 10px;
      border: 1px solid #ccc;
      height: 200px;
      overflow-y: auto;
    }
  </style>
  <!-- Ace Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
</head>
<body>
  <h1>Pyodide met Ace Editor</h1>

  <div id="editor">print("Hallo vanuit Pyodide!")</div>
  <button onclick="runPython()">Run Python</button>
  <h3>Output:</h3>
  <div id="output"></div>
  <input id="shell-input" placeholder=">>> Typ een expressie of statement" autocomplete="off" />

  <script>

    
let example = 
`import math

def isPrime(n):
    wn = math.sqrt(n)
    wn = math.trunc(wn)
    for k in range(2,wn+1):
        if n % k == 0:
            return False
    return True

def goldbach_bounded(b):
    # every even number is the sum of 2 primes
    # program
    n = 4
    while n < b:
        if not isSum2Primes(n):
            return False
        n += 2
    return True

def goldbach():
    # every even number is the sum of 2 primes
    # program
    n = 4
    while True:
        if not isSum2Primes(n):
            return False
        n += 2
    return True

def isSum2Primes(n):
    for k in range(2,n//2+1):
        if isPrime(k) and isPrime(n-k):
            return True
    return False
print(goldbach_bounded(10000))

def som(n):
  if n == 0: 
    return 0;
  else:
    return n + som(n-1)
`
function appendToShell(text) {
      const div = document.getElementById("output");
      div.textContent += text + "\n";
      div.scrollTop = div.scrollHeight;
    }

    const editor = ace.edit("editor");
    //editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");
    editor.setValue(example,-1);

    let pyodide = null;

    async function startPyodide() {
      pyodide = await loadPyodide();

      // Output div
      const outputDiv = document.getElementById("output");

      // JS object dat print opvangt
      const outputCatcher = {
        write: (s) => {
          outputDiv.textContent += s;
        },
        flush: () => {}
      };

      // Zet Python stdout/stderr naar JS
      pyodide.globals.set("stdout", outputCatcher);
      pyodide.globals.set("stderr", outputCatcher);

      await pyodide.runPythonAsync(`
import sys
sys.stdout = stdout
sys.stderr = stderr
del stdout, stderr
`);
    }

    startPyodide();

    async function runPython() {
      const outputDiv = document.getElementById("output");
      outputDiv.textContent = ""; // reset

      const code = editor.getValue();

      try {
        await pyodide.runPythonAsync(code);
      } catch (err) {
        outputDiv.textContent += filterError(err.toString());
      }
    }

    function filterError(e) {
      e = e.toString();
      while (e.includes('^^^')) e = e.match(/\^+(.*)/s)[1];
      return e;
    }

    let history = [];
    let historyIndex = -1;

    document.getElementById("shell-input").addEventListener("keydown", async (e) => {
      const inputField = e.target;

      if (e.key === "Enter") {
        e.preventDefault();
        const input = inputField.value.trim();
        if (input === "") return;

        appendToShell(">>> " + input);
        history.push(input);
        historyIndex = history.length;

        inputField.value = "";

        try {
          try {
            await pyodide.runPythonAsync(`__shell_result = (${input})`);
            await pyodide.runPythonAsync("print(__shell_result)");
            await pyodide.runPythonAsync("del __shell_result");
          } catch (evalErr) {
            await pyodide.runPythonAsync(input);
          }
        } catch (err) {
          appendToShell("Fout:\n" + filterError(err.toString()));
        }
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        if (history.length > 0 && historyIndex > 0) {
          historyIndex--;
          inputField.value = history[historyIndex];
        }
      } else if (e.key === "ArrowDown") {
        e.preventDefault();
        if (historyIndex < history.length - 1) {
          historyIndex++;
          inputField.value = history[historyIndex];
        } else {
          historyIndex = history.length;
          inputField.value = "";
        }
      }
    });

  </script>
</body>
</html>