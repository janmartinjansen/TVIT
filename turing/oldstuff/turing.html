<html>
<head>
<link rel="stylesheet" href="editor.css">
<script src="./skulpt.min.js" type="text/javascript"></script>
<script src="./skulpt-stdlib.js" type="text/javascript"></script>
<script language="javascript" type="text/javascript" src="./viz.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/ace.js" type="text/javascript" charset="utf-8"></script>

<title>Turing Machine</title>

</head>

<body>

<script type="text/javascript">

function outf(text) {
  if (text != '\n') {
    var mypre = document.getElementById("output");
    var svg = Viz(text, "svg");
    mypre.innerHTML = svg;
  }
}

function outf2(text) {
  if (text != '\n') {
    var mypre = document.getElementById("result");
    //console.log(text)
    mypre.innerHTML = text
  }
}

function builtinRead(x) {
    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
            throw "File not found: '" + x + "'";
    return Sk.builtinFiles["files"][x];
}

function makeStr(txt) {
  res = "'"
  for (var t of txt) {
    if (t == '\n') {
      res += "\\n"
    }
    else res += t
  }
  res += "'"
  return res
}

function readIt() {
   var prog = document.getElementById("yourcode").value;
   //var prog = pythoncode;
   var input = editor.getValue()//document.getElementById("inputdata").value;
   var mypre = document.getElementById("output");
   input = makeStr(input)
   var mycode = 'makeDOT(' + input + ')';
   console.log(mycode)
   prog += mycode
   mypre.innerHTML = '';
   Sk.pre = "output";
   Sk.configure({output:outf, read:builtinRead});
  // (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'mycanvas';
   var myPromise = Sk.misceval.asyncToPromise(function() {
       return Sk.importMainWithBody("<stdin>", false, prog, true);
   });
   myPromise.then(function(mod) {
       console.log('success');
   },
       function(err) {
       console.log(err.toString());
   });
}

function testIt() {
   var prog = document.getElementById("yourcode").value;
   //var prog = pythoncode;
   var testinput = document.getElementById("instr").value;
   var input = editor.getValue()//document.getElementById("inputdata").value;
   var mypre = document.getElementById("output");
   input = makeStr(input)
   var mycode =  'sim(' + input + ',' + makeStr(testinput) + ')';
   console.log(mycode)
   prog += mycode
   Sk.pre = "output";
   Sk.configure({output:outf2, read:builtinRead});
   //(Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'mycanvas';
   var myPromise = Sk.misceval.asyncToPromise(function() {
       return Sk.importMainWithBody("<stdin>", false, prog, true);
   });
   myPromise.then(function(mod) {
       console.log('success');
   },
       function(err) {
       console.log(err.toString());
   });
}

function loadFile() {
  var myfile = document.getElementById("uploadInput").files[0]
	var reader = new FileReader()
	reader.readAsText(myfile);
	reader.onload = function (event) {
		 editor.setValue(event.target.result);
	}
}

function saveTM() {
  if ('Blob' in window) {
    var fileName = prompt('Please enter file name to save', 'tm.txt');
    if (fileName) {
      var textToWrite = editor.getValue();
      var textFileAsBlob = new Blob([textToWrite], { type: 'text/plain' });

      if ('msSaveOrOpenBlob' in navigator) {
        navigator.msSaveOrOpenBlob(textFileAsBlob, fileName);
      } else {
        var downloadLink = document.createElement('a');
        downloadLink.download = fileName;
        downloadLink.innerHTML = 'Download File';
        if ('webkitURL' in window) {
          // Chrome allows the link to be clicked without actually adding it to the DOM.
          downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
        } else {
          // Firefox requires the link to be added to the DOM before it can be clicked.
          downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
          downloadLink.onclick = destroyClickedElement;
          downloadLink.style.display = 'none';
          document.body.appendChild(downloadLink);
        }

        downloadLink.click();
      }
    }
  } else {
    alert('Your browser does not support files.');
  }
}


</script>

<h2>Turing Machine Simulator</h2>
<p>
Try example 1 or 2 or enter (or upload) your own Turing Machine, using the format:
<pre> f r w dir t (from read write L/R to) </pre>
blanks '_' are automatically added at the end of the tape as the cursor is moved to that position!
</p>
<p>
<button type="button" style="width: 80px;" onclick="doVB(1)">Example 1</button>
<button type="button" style="width: 80px;" onclick="doVB(2)">Example 2</button>

<span id="description"></span>
</p>

<button type="button" style="width: 80px;" onclick="testIt()">Simulate</button>
Input tape:<input type="text" id="instr">
<span id="result"></span><br>
<button type="button" style="width: 80px;" onclick="readIt()">Display</button>
Generate graphical representation of the TM.
<div class="flex-container">
<pre id="inputdata" ></pre>
<pre id="output"></pre>
</div>
<br>
<div>Upload your own Turing Machine description from file.
<br>
<input id="uploadInput" type="file" name="myfile" accept=".txt" onchange="loadFile();">

<br>
<button type="button" style="width: 80px;" onclick="saveTM()">Save</button>
To save the TM to file.
</div>

<textarea id="yourcode" type="hidden" cols="40" rows="1" hidden>
def readTuring(fname):
    with open(fname,'r') as f:
        lines = f.readlines()
        return readTMLines(lines)

def readTMText(txt):
    lines = txt.split('\n')
    return readTMLines(lines)

def readTMLines(lines):
    transitions = []
    k = 1
    rstates = []
    for line in lines:
        ws = line.split()
        if len(ws) > 0 and ws[0] == 'start':
            if not(len(ws) == 2):
                return (False,"error in line " + str(k) + " start: start state")
            startstate = ws[1]
        elif len(ws) > 0 and ws[0] == 'accept':
            if not(len(ws) >= 2):
                return (False,"error in line " + str(k) + " accept: accept states (at least one)")
            endstates = ws[1:]
        elif len(ws) > 0 and ws[0] == 'reject':
            if not(len(ws) >= 2):
                return (False,"error in line " + str(k) + " accept: accept states (at least one)")
            rstates = ws[1:]
        elif len(ws) == 5:
            start = ws[0]
            sym   = ws[1]
            wsym  = ws[2]
            lr    = ws[3]
            end   = ws[4]
            transitions.append((start,sym,wsym,lr,end))
        elif len(ws) > 0:
            return (False,"error in line " + str(k) + " transition: fromstate readsym writesim L/R tostate")
        k += 1
    return (True,(transitions,startstate,endstates,rstates))

def genDot(tm):
    dot = 'digraph finite_state_machine {\n rankdir=LR; \n size="8,5"\n'
    ts,ss,ess,rss = tm
    dot += '  node [fontsize=10, fontname="Monospace",shape = point] start;\n'
    dot += '  node [shape = doublecircle] ' + ' '.join(ess) + ';\n'
    dot += '  node [shape = circle];\n'
    dot += '  edge[fontsize=11, fontname="Monospace"];\n'
    dot += '  start -> ' + ss + ';\n'
    for (f,s,ws,lr,t) in ts:

        dot += '    ' + f + ' -> ' + t + ' [ label = "'  + (s if s == ws else s +  '|' + ws) + ' ' + lr + '" ];\n'
        # dot += '    ' + f + ' -> ' + t + ' [ label = "'  +  s +  '/' + ws + ' ' + lr + '" ];\n'
    dot += '}\n'
    return dot

def simTuring(tm,tape):
    ts,start,ess,rss = tm
    state = start
    pos = 0
    while state not in ess and state not in rss:
        sym = tape[pos]
        res = [(ws,d,qe) for q,rs,ws,d,qe in ts if  state == q and sym == rs]
        if len(res) == 0:
            # print("no rule for: ",state,sym)
            return ('Reject',tape)
        else:
            print(res[0])
            tape[pos],d,state = res[0]
            pos += 1 if  d == 'R' else  -1
            if pos >= len(tape):
                tape.append('_')
    if state in ess:
        return ('Accept',tape)
    else:
        return ('Reject',tape)

# tvb1.txt: whwb met w (0|1)*, dus voor en na h zelfde string, b afsluitsynbool
# tvb2: 0 * 2^n  b afsluitsynbool: aantal nullen is macht van 2

def test1(inp):
    (ok,tm) = readTuring('tvb1.txt')
    if not ok:
        print(tm)
    else:
        print(simTuring(tm,list(inp)))

def test2(inp):
    (ok,tm) = readTuring('tvb2.txt')
    if not ok:
        print(tm)
    else:
        print(simTuring(tm,list(inp)))

def plotTM(filename):
    (ok,tm) = readTuring(filename)
    if not ok:
        print(tm)
    else:
        print(genDot(tm))

def readSimTM(filename,tape):
    (ok,tm) = readTuring(filename)
    if not ok:
        print('error in input')
    else:
        print(simTuring(tm,list(tape)))

def makeDOT(txt):
    (ok,tm) = readTMText(txt)
    if not ok:
        print(tm)
    else:
        print(genDot(tm))
def sim(txt,tape):
    (ok,tm) = readTMText(txt)
    if ok:
        print(simTuring(tm,list(tape)))

</textarea>
</body>
<script type="text/javascript">
// output functions are configurable.  This one just appends some text
// to a pre element.
var editor = ace.edit("inputdata");
editor.setOption("minLines", 80);
//editor.setTheme("ace/theme/tomorrow_night_eighties");
editor.setAutoScrollEditorIntoView(true);

function doVB(vb) {
  if (vb == 1) {
    editor.setValue(vbtm1)
    document.getElementById("description").innerHTML = 'before and after # the same string containing only 0 and 1'
    document.getElementById("instr").value = '001#001'
  }
  else if (vb == 2) {
    editor.setValue(vbtm2)
    document.getElementById("description").innerHTML = 'number of 0\'s must be power of 2'
    document.getElementById("instr").value = '0000'
  }
}
var vbtm1 =
`q1 0 x R q2
q1 1 x R q3
q2 0 0 R q2
q2 1 1 R q2
q2 # # R q4
q3 0 0 R q3
q3 1 1 R q3
q3 # # R q5
q4 x x R q4
q4 0 x L q6
q5 x x R q5
q5 1 x L q6
q6 # # L q7
q6 0 0 L q6
q6 1 1 L q6
q6 x x L q6
q7 0 0 L q7
q7 1 1 L q7
q7 x x R q1
q1 # # R q8
q8 x x R q8
q8 _ _ R q9
accept q9
start q1
`
var vbtm2 =
`q1 0 _ R q2
q2 _ _ R qe
q2 x x R q2
q2 0 x R q3
q3 x x R q3
q3 0 0 R q4
q3 _ _ L q5
q4 x x R q4
q4 0 x R q3
q5 0 0 L q5
q5 x x L q5
q5 _ _ R q2
start q1
accept qe
`

</script>
</html>
